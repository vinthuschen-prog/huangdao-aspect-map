<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huangdao Aspect & Outdoor Map</title>

    <!-- Google Font + Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box;}

        body {
            font-family: "Poppins", sans-serif;
            background: #f2f5f7;
            color: #333;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        /* Night mode */
        body.night-mode {
            background: #2f3b52;
            color: #f7f7f7;
        }

        /* Header */
        .header {
            width: 100%;
            text-align: center;
            background: url("https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1600&q=80") center/cover;
            padding: 80px 20px 20px;
            color: white;
            text-shadow: 0 3px 8px rgba(0,0,0,0.5);
        }
        .header h1 {
            font-size: 3.2rem;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Main layout */
        .main-container {
            display: flex;
            justify-content: center;
            gap: 25px;
            padding: 30px;
        }

        .side-panel {
            width: 350px;
            background: white;
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 600;
            color: #2F4F4F;
            cursor: help;
        }

        /* Weather */
        .weather-box {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 6px solid #3a7c47;
        }
        .weather-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
        }
        .weather-temp {
            font-size: 2rem;
            font-weight: 600;
            color: #2a5298;
        }

        /* Legend */
        .legend-box {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            border-left: 6px solid #c27b25;
            margin-bottom: 25px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 10px;
            border-radius: 3px;
        }

        /* Knowledge */
        .knowledge-box {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            border-left: 6px solid #2f6f9f;
        }
        .knowledge-box ul {
            margin-left: 18px;
            line-height: 1.7;
        }

        /* Map */
        #map {
            flex-grow: 1;
            height: 700px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* Night mode toggle */
        .mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: #2a5298;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
        }
        .mode-toggle:focus { outline: none;}

        /* Footer */
        footer {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            color: #4f5b66;
        }
    </style>
</head>

<body>

    <!-- Night mode toggle -->
    <button class="mode-toggle" onclick="toggleNightMode()" title="å¤œé—´æ¨¡å¼ï¼ˆDark Modeï¼‰">
        <i class="fa-solid fa-moon"></i>
    </button>

    <!-- Header -->
    <div class="header">
        <h1 title="é»„å²›åŒºå¡å‘åˆ†å¸ƒå›¾">
            <i class="fa-solid fa-mountain-sun"></i> Huangdao Aspect Map
        </h1>

        <p title="ä¸ºç™»å±±ã€éª‘è¡Œå’Œå¾’æ­¥çˆ±å¥½è€…è®¾è®¡ â€”â€” äº†è§£å¡å‘å¦‚ä½•å½±å“ä½ çš„æˆ·å¤–ä½“éªŒ">
            Designed for Mountaineers, Cyclists & Hikers â€” Discover How Slope Direction Shapes Your Outdoor Experience
        </p>
    </div>

    <!-- Main Content -->
    <div class="main-container">

        <!-- Side Panel -->
        <div class="side-panel">

            <!-- Weather -->
            <h2 class="section-title" title="å½“å‰å¤©æ°”">ğŸŒ¤ Current Weather</h2>
            <div id="weatherBox" class="weather-box">Loading weather...</div>

            <!-- Legend -->
            <h2 class="section-title" title="å¡å‘å›¾ä¾‹">ğŸ§­ Aspect Legend</h2>
            <div class="legend-box">
                <div class="legend-item"><div class="legend-color" style="background:#ff0000"></div> Northï¼ˆåŒ—ï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#ffa500"></div> Northeastï¼ˆä¸œåŒ—ï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#ffff00"></div> Eastï¼ˆä¸œï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#00ff00"></div> Southeastï¼ˆä¸œå—ï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#00ffff"></div> Southï¼ˆå—ï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#0000ff"></div> Southwestï¼ˆè¥¿å—ï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#8a2be2"></div> Westï¼ˆè¥¿ï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#ff00ff"></div> Northwestï¼ˆè¥¿åŒ—ï¼‰</div>
                <div class="legend-item"><div class="legend-color" style="background:#c0c0c0"></div> Flat / No Aspectï¼ˆå¹³åœ° / æ— å¡å‘ï¼‰</div>
            </div>

            <!-- Outdoor Knowledge -->
            <h2 class="section-title" title="æˆ·å¤–è¿åŠ¨æç¤º">â›° Outdoor Tips</h2>
            <div class="knowledge-box">
                <ul>
                    <li title="å—å¡æ¸©æš–ï¼Œé€‚åˆå†¬å­£å¾’æ­¥">South-facing slopes are warmer and great for winter hiking.</li>
                    <li title="åŒ—å¡æ¹¿æ¶¦é˜´å‡‰ï¼Œå°å¿ƒåœ°é¢æ¹¿æ»‘">North-facing slopes stay moist & shadedâ€”watch for slippery surfaces.</li>
                    <li title="ä¸œå¡å—å…‰æ—©ï¼Œé€‚åˆæ™¨è·‘">East-facing slopes get early sunlightâ€”best for morning runs.</li>
                    <li title="è¥¿å¡ä¸‹åˆç‚çƒ­ï¼Œéœ€å‡†å¤‡è¶³å¤Ÿæ°´">West-facing slopes heat up in afternoonâ€”prepare enough water.</li>
                    <li title="å—å¡ç§¯é›ªèåŒ–å¿«ï¼Œé€‚åˆæ˜¥å­£ç™»å±±">Steep south-facing terrain melts snow fasterâ€”ideal for spring trekking.</li>
                </ul>
            </div>

        </div>

        <!-- Map -->
        <div id="map" title="äº¤äº’å¼å¡å‘åœ°å›¾ï¼ˆInteractive Aspect Mapï¼‰"></div>

    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Map Script -->
    <script>
        var map = L.map('map').setView([35.95, 120.15], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        L.tileLayer('tiles_aspect/{z}/{x}/{y}.png', {
            minZoom: 10,
            maxZoom: 16,
            opacity: 0.85
        }).addTo(map);

        /* Weather API Script */
        const lat = 35.9606;
        const lon = 120.1693;

        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
            .then(res => res.json())
            .then(data => {
                const w = data.current_weather;
                document.getElementById("weatherBox").innerHTML = `
                    <div class="weather-row"><span>Temperature:</span><span class="weather-temp">${w.temperature}Â°C</span></div>
                    <div class="weather-row"><span>Wind Speed:</span><span>${w.windspeed} km/h</span></div>
                    <div class="weather-row"><span>Wind Direction:</span><span>${w.winddirection}Â°</span></div>
                    <div class="weather-row"><span>Weather Code:</span><span>${w.weathercode}</span></div>
                `;
            });

        /* Night Mode Toggle */
        function toggleNightMode() {
            document.body.classList.toggle("night-mode");
            const moon = document.querySelector(".fa-moon");
            moon.classList.toggle("fa-sun");
        }
    </script>
<script>

// ç‚¹å‡»æŸ¥è¯¢å¡å‘
map.on("click", function (e) {
    let lat = e.latlng.lat;
    let lon = e.latlng.lng;

    // æ ¹æ®åƒç´ é¢œè‰²åˆ¤æ–­å¡å‘ï¼ˆéœ€å¯¹åº”ä½ çš„ç“¦ç‰‡é¢œè‰²ï¼‰
    getAspectFromTile(e.latlng, function (aspectDeg, aspectText) {
        let popupContent = `
            <b>Aspect:</b> ${aspectText} (${aspectDeg}Â°)<br>
            <b>Location:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}
        `;
        L.popup()
            .setLatLng(e.latlng)
            .setContent(popupContent)
            .openOn(map);
    });
});

// ä»ç“¦ç‰‡é¢œè‰²æ¨æ–­å¡å‘
function getAspectFromTile(latlng, callback) {

    let zoom = map.getZoom();
    let tileSize = 256;

    // è®¡ç®—ç“¦ç‰‡ç¼–å· (x,y)
    let point = map.project(latlng, zoom);
    let xTile = Math.floor(point.x / tileSize);
    let yTile = Math.floor(point.y / tileSize);

    // è®¡ç®—åƒç´ ä½ç½®ï¼ˆåœ¨ç“¦ç‰‡å†…éƒ¨ï¼‰
    let xPixel = Math.floor(point.x % tileSize);
    let yPixel = Math.floor(point.y % tileSize);

    let tileUrl = `tiles_aspect/${zoom}/${xTile}/${yTile}.png`;

    let img = new Image();
    img.crossOrigin = "Anonymous";
    img.src = tileUrl;

    img.onload = function () {
        let canvas = document.createElement("canvas");
        canvas.width = tileSize;
        canvas.height = tileSize;
        let ctx = canvas.getContext("2d");

        ctx.drawImage(img, 0, 0);

        let pixel = ctx.getImageData(xPixel, yPixel, 1, 1).data;
        let rgb = `${pixel[0]},${pixel[1]},${pixel[2]}`;

        let aspectInfo = decodeAspect(rgb);

        callback(aspectInfo.deg, aspectInfo.text);
    };

    img.onerror = function () {
        callback("â€“", "No Data");
    };
}

// é¢œè‰² â†’ å¡å‘æ˜ å°„ï¼ˆå¿…é¡»å¯¹åº”ä½ å¯¼å‡ºçš„é¢œè‰²ï¼‰
function decodeAspect(rgb) {

    const mapping = {
        "255,0,0":   { deg: 0, text: "North" },
        "255,165,0": { deg: 45, text: "Northeast" },
        "255,255,0": { deg: 90, text: "East" },
        "0,255,0":   { deg: 135, text: "Southeast" },
        "0,255,255": { deg: 180, text: "South" },
        "0,0,255":   { deg: 225, text: "Southwest" },
        "138,43,226":{ deg: 270, text: "West" },
        "255,0,255": { deg: 315, text: "Northwest" },
        "192,192,192": { deg: 999, text: "Flat" }
    };

    if (mapping[rgb]) return mapping[rgb];

    return { deg: "â€“", text: "Unknown" };
}

</script>

    <!-- Footer -->
    <footer>
        by <b>UPC 2416020217 Jiajun Chen</b>
    </footer>

</body>
</html>
